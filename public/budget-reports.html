<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Budget Reports</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body style="background-color: #a2c2f4; font-family: Arial, sans-serif;">

  <h1 style="text-align: center; font-size: 32px; margin-top: 20px;">budget reports</h1>

  <table border="1" cellpadding="10" style="width: 90%; margin: 20px auto; border-collapse: collapse; text-align: center;">
    <thead style="background-color: #4b7bec; color: white;">
      <tr>
        <th>Department</th>
        <th>Department Head</th>
        <th>Amount</th>
        <th>Comments</th>
        <th>Email to Me</th>
        <th>Download PDF</th>
      </tr>
    </thead>
    <tbody id="report-table" style="background-color: white;"></tbody>
  </table>

  <h2 style="text-align: center; font-size: 24px;">Overall Department Budget Share</h2>
  <div style="display: flex; justify-content: center;">
    <canvas id="budgetPieChart" style="max-width: 600px; background-color: white; padding: 20px; border-radius: 10px;"></canvas>
  </div>

  <script>
    let pdfChartInstance = null;

    fetch('/api/budget-reports-data')
      .then(res => res.json())
      .then(data => {
        const table = document.getElementById('report-table');
        let labels = [], values = [];

        data.forEach(row => {
          labels.push(row.department_name);
          values.push(Number(row.requested_budget.toString().replace(/[^0-9.]/g, '')));


          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row.department_name}</td>
            <td>${row.department_head}</td>
            <td>₹${row.requested_budget}</td>
            <td>${row.admin_comments || '—'}</td>
            <td><button onclick='emailPDFToUser(${JSON.stringify(row)})'>Email to Me</button></td>
            <td><button onclick='generatePDF(${JSON.stringify(row)})'>Download PDF</button></td>
          `;
          table.appendChild(tr);
        });

        // Save for use in chart
        window.chartLabels = labels;
        window.chartValues = values;

        const ctx = document.getElementById('budgetPieChart').getContext('2d');
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels,
            datasets: [{
              label: 'Budget Share',
              data: values,
              backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#66BB6A',
                '#BA68C8', '#FFA07A', '#90CAF9', '#F06292'
              ],
              borderColor: '#ffffff',
              borderWidth: 2
            }]
          },
          options: {
            plugins: {
              legend: { position: 'right' },
              datalabels: {
                color: '#fff',
                font: { weight: 'bold', size: 14 },
                formatter: (value, ctx) => {
                  const label = ctx.chart.data.labels[ctx.dataIndex];
                  const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  return `${label}\n${((value / total) * 100).toFixed(1)}%`;
                }
              }
            }
          },
          plugins: [ChartDataLabels]
        });
      });

    function fillPDFFields(row) {
      document.getElementById('pdf-dept-name').textContent = row.department_name;
      document.getElementById('pdf-department-name').textContent = row.department_name;
      document.getElementById('pdf-department-head').textContent = row.department_head;
      document.getElementById('pdf-requested-amount').textContent = row.requested_budget;
      document.getElementById('pdf-budget-status').textContent = row.budget_status || '—';
      document.getElementById('pdf-admin-comments').textContent = row.admin_comments || '—';
      document.getElementById('pdf-email').textContent = 'admin@example.com';
    }

    function renderPDFChart() {
      const canvas = document.getElementById('pdf-chart');
      canvas.width = 600;
      canvas.height = 400;
      const ctx = canvas.getContext('2d');

      if (pdfChartInstance) {
        pdfChartInstance.destroy();
      }

      pdfChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: window.chartLabels,
          datasets: [{
            data: window.chartValues,
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#66BB6A',
              '#BA68C8', '#FFA07A', '#90CAF9', '#F06292'
            ],
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          animation: false,
          plugins: {
            legend: { position: 'right' },
            title: { display: false }
          }
        }
      });
    }

    function generatePDF(row) {
      fillPDFFields(row);
      renderPDFChart();

      setTimeout(() => {
        const content = document.getElementById('pdf-content');
        html2canvas(content, { useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p', 'pt', 'a4');
          const width = pdf.internal.pageSize.getWidth();
          const height = (canvas.height * width) / canvas.width;
          pdf.addImage(imgData, 'PNG', 20, 20, width - 40, height - 60);
          pdf.save(`${row.department_name}_Budget_Report.pdf`);
        });
      }, 1000);
    }

    async function emailPDFToUser(row) {
  fillPDFFields(row);
  renderPDFChart();

  setTimeout(() => {
    const content = document.getElementById('pdf-content');
    html2canvas(content, { useCORS: true, backgroundColor: "#ffffff" }).then(async canvas => {
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'a4');
      const width = pdf.internal.pageSize.getWidth();
      const height = (canvas.height * width) / canvas.width;
      pdf.addImage(imgData, 'PNG', 20, 20, width - 40, height - 60);

      const pdfBlob = pdf.output('blob');

      const formData = new FormData();
      formData.append('pdf', pdfBlob, `${row.department_name}_Budget_Report.pdf`);
      formData.append('data', JSON.stringify(row));

      try {
        const response = await fetch('/email-budget-report', {
          method: 'POST',
          body: formData
        });

        const result = await response.text();
        alert(result);
      } catch (err) {
        console.error(err);
        alert("Failed to send email.");
      }
    });
  }, 1000);
}


    window.generatePDF = generatePDF;
  </script>

  <!-- Hidden PDF content -->
  <div id="pdf-content" style="position: absolute; left: -9999px; top: -9999px;">
    <div style="padding: 30px; font-family: Arial, sans-serif;">
      <h2 style="color: #3b2fd4;">BUDGET REPORT FOR DEPARTMENT <span id="pdf-dept-name" style="text-transform: uppercase;"></span></h2>
      <div style="background-color: #e9cfcf; padding: 20px; font-size: 16px;">
        <p><b>Department name :</b> <span id="pdf-department-name"></span></p>
        <p><b>Department head :</b> <span id="pdf-department-head"></span></p>
        <p><b>Amount requested :</b> ₹<span id="pdf-requested-amount"></span></p>
        <p><b>Approval status :</b> <span id="pdf-budget-status"></span></p>
        <p><b>Admin comments :</b><br><span id="pdf-admin-comments"></span></p>
        <p><b>Email for queries :</b> <span id="pdf-email"></span></p>
      </div>
      <h3 style="margin-top: 40px;">Departmental income percentage :</h3>
      <canvas id="pdf-chart" width="500" height="320" style="margin-top: 20px;"></canvas>
    </div>
  </div>

</body>
</html>
